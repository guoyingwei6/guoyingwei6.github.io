---
layout: post
title: "【统计学】卡方检验和Fisher精确检验"
author: "Yingwei Guo"
categories: 
tags: 统计学
image: 
---

## 什么是卡方检验

卡方检验是一种用途很广的计数资料的假设检验方法。它属于非参数检验的范畴，主要是比较两个及两个以上样本率( 构成比）以及两个分类变量的关联性分析。其根本思想就是在于比较理论频数和实际频数的吻合程度或拟合优度问题。
它在分类资料统计推断中的应用，包括：两个率或两个构成比比较的卡方检验；多个率或多个构成比比较的卡方检验以及分类资料的相关分析等。
 
一、四格表资料的卡方检验
例1.两组大白鼠在不同致癌剂作用下的发癌率如下表，问两组发癌率有无差别？
表1

（52 19 39 3） 这四个数据是整个表中的基本资料，其余数据均由此推算出来；这四格资料表就专称四格表（fourfold table），或称2行2列表（2×2 contingency table）。从该资料算出的两组发癌率分别为73.24%和92.86%，两者的差别可能是抽样误差所致，亦可能是两组发癌率（总体率）确有所不同。这里可通过卡方检验来区别其差异有无统计学意义，检验的基本公式为：

式中A为实际数，以上四格表的四个数据就是实际数。T为理论数，是根据检验假设推断出来的；即假设这两组的发癌率本无不同，差别仅是由抽样误差所致。这里可将两组合计发癌率作为理论上的发癌率，即91/113=80.3%，以此为依据便可推算出四格表中相应的四格的理论数。以表1资料为例检验如下。
检验步骤：
1.建立检验假设：
H0：π1=π2；H1：π1≠π2；α=0.05
2.计算理论数（TRC），计算公式为：
TRC=nR.nC/n
式中TRC是表示第R行C列格子的理论数，nR为理论数同行的合计数，nC为与理论数同列的合计数，n为总例数。
第1行1列： 71×91/113=57.18
第1行2列： 71×22/113=13.82
第2行1列： 42×91/113=33.82
第2行2列： 42×22/113=8.18
以推算结果，可与原四项实际数并列成表2：
表2

因为上表每行和每列合计数都是固定的，所以只要用TRC式求得其中一项理论数（例如T1.1=57.18），则其余三项理论数都可用同行或同列合计数相减，直接求出。
3.计算卡方值按公式代入

=0.47+1.94+0.79+3.28=6.48
4.查卡方值表求P值
在查表之前应知本题自由度。按卡方检验的自由度v=（行数-1）（列数-1），则该题的自由度v=（2-1）（2-1）=1，查卡方界值表，找到

，而本题卡方=6.48即卡方＞

，P＜0.05，差异有显著统计学意义，按α=0.05水准，拒绝H0，可以认为两组发癌率有差别。
通过实例计算，读者对卡方的基本公式有如下理解：若各理论数与相应实际数相差越小，卡方值越小；如两者相同，则卡方值必为零，而卡方永远为正值。又因为每一对理论数和实际数都加入卡方值中，分组越多，即格子数越多，卡方值也会越大，因而每考虑卡方值大小的意义时同时要考虑到格子数。因此自由度大时，卡方的界值也相应增大。
 
二、四格表卡方值的校正
卡方值表是数理统计根据正态分布中

的定义计算出来的。是一种近似。在自由度大于1、理论数皆大于5时，这种近似很好；当自由度为1时，尤其当1＜T＜5，而n＞40时，应用以下校正公式：

例2.某医师用甲、乙两疗法治疗小儿单纯性消化不良，结果如表3.试比较两种疗法效果有无差异？
表3

从表3可见，T1.2和T2.2数值都＜5，且总例数大于40，故宜用校正公式检验。步骤如下：
1.检验假设：
H0：π1=π2；H1：π1≠π2；α=0.05
2.计算理论数：（已完成列入四格表括弧中）
3.计算卡方值：应用校正公式运算如下：

查卡方界值表，

，故卡方＜

，P＞0.05。按α=0.05水准，接受H0，两种疗效差异无统计学意义。 
如果不采用校正公式，而用原基本公式，算得的结果卡方=4.068，则结论就不同了。
如果观察资料的T＜1或n＜40时，四格表资料用上述校正法也不行，可参考预防医学专业用的医学统计学教材中的Fisher精确检验法直接计算概率以作判断。
 
三、行×列表的卡方检验
适用于两个组以上的率或百分比差别的显著性检验。其检验步骤与上述相同，简单计算公式如下： 

式中n为总例数；A为各观察值；nR和nC为与各A值相应的行和列合计的总数。
例3.北方冬季日照短而南移，居宅设计如何适应以获得最大日照量，增强居民体质，减少小儿佝偻病，实属重要。胡氏等1986年在北京进行住宅建筑日照卫生标准的研究，对214幢楼房居民的婴幼儿712人体检，检出轻度佝偻病333例，比较了居室朝向与患病的关系。现将该资料归纳如表4作行×列检验。
表4

该表资料由2行4列组成，称2×4表，可用行×列卡方公式检验。
（一）检验步骤
1.检验假设
H0：四类朝向居民婴幼儿佝偻病患病率相同；H1：四类朝向居民婴幼儿佝偻病患率不同；α=0.05
2.计算卡方值

3.确定P值和分析
本题v=（2-1）（4-3）=3，据此查卡方界值表：

，本题卡方=15.08，卡方＞

 ，P＜0.05，拒绝H0，可以认为居室朝向不同的居民，婴幼儿佝偻病患病率有差异。
（二）行×列表卡方检验注意事项
1.一般认为行×列表中不宜有1/5以上格子的理论数小于5，或有小于1的理论数。当理论数太小可采取下列方法处理：①增加样本含量以增大理论数；②删去上述理论数太小的行和列；③将太小理论数所在行或列与性质相近的邻行邻列中的实际数合并，使重新计算的理论数增大。由于后两法可能会损失信息，损害样本的随机性，不同的合并方式有可能影响推断结论，故不宜作常规方法。另外，不能把不同性质的实际数合并，如研究血型时，不能把不同的血型资料合并。
2.如检验结果拒绝检验假设，只能认为各总体率或总体构成比之间总的来说有差别，但不能说明它们彼此之间都有差别，或某两者间有差别。


## Fisher exact test

Fisher测试某位女士是否能分辨出先放茶再加奶和先放奶再冲茶的味道是否不同。这个测试就是后来著名的Fisher精确检验。
作为一个数据分析伪从业人员，我对Fisher精确检验很感兴趣， 但一开始就被2*2的实验结果列联表搞蒙了，看不明白这个表格含义所在，为何要弄出这么一个表格来。于是就搜索了Fisher精确检验的详细资料，翻阅资料后把自己的理解用非专业的词汇总结一下。
Fisher精确检验原理描述：
假设检验用来检验一次随机实验的结果是否支持对于某个随机实验的假设。具体如下：随机事件发生的概率小于0.05则认定该事件为小概率事件。一般原则认为在某个假设前提下，一次随机实验的结果不会出现小概率事件。若一次随机实验的结果出现了小概率事件则认定该假设不被支持。
 
1. 理论依据是：超几何分布（无放回产品抽样实验）：非卡方检验的范畴。超几何分布的一个形象例子是：有N件物品，M件为次品，求取n件，其中有k件为次品的概率。=(M,k)*(N-M,n-k)/(N,n)
2. 基本思想是：在2*2列联表中，四格表周边和（即边际分布）计数固定不变的条件下，计算表内4个实际频数变动时的各种组合之概率Pi；而这个具体的实例可以分解出8个类似产品抽样实验的具体实例结果。根据给出的数据可以计算出每个抽样结果基于假设的超几何分布概率。根据其中之一抽样结果的概率，通过假设检验的原则即可推定假设是否成立。
注：以上两条来源：http://blog.sina.com.cn/s/blog_6b1c9ed50101kh2f.html
超几何分布是统计学上一种离散概率分布。它描述了由有限个物件中抽出n个物件，成功抽出指定种类的物件的次数（不归还）。称为超几何分布，是因为其形式与“超几何函数”的级数展式的系数有关。
例如 判断节食与性别是否相关：
                   男        女
节食                a         b
不节食              c         d
 
四格表周边和（即边际分布）计数固定不变的条件下(男性总数固定(a+c)，女性总数不变(b+d)，节食总人数不变(a+c)，不节食总人数不变(c+d))，可以分解出下列超几何分布抽样：
1. 一共 （a+b+c+d)人，其中男性(a+c)人, 节食有(a+b)人，则其中节食男性为a人的概率;
2. 一共 （a+b+c+d)人，其中男性(a+c)人, 不节食有(c+d)人，则其中不节食男性为c人的概率；
3. 一共 （a+b+c+d)人，其中女性(b+d)人, 节食有(a+b)人，则其中节食女性为b人的概率；
4. 一共 （a+b+c+d)人，其中女性(b+d)人, 不节食有(c+d)人，则其中不节食女性为d人的概率；
5. 一共 （a+b+c+d)人，其中节食(a+b)人, 男性(a+c)人，则其中节食男性为a人的概率；
6. 一共 （a+b+c+d)人，其中节食(a+b)人, 女性(b+d)人，则其中节食女性为b人的概率；
7. 一共 （a+b+c+d) 人，其中不节食(c+d)人, 男性(a+c)人，则其中不节食男性为c人的概率；
8. 一共 （a+b+c+d)人，其中不节食(c+d)人, 女性(b+d)人，则其中不节食女性为d人的概率；
 
Fisher精确检验是统计显著性检验方法，用于检查两个二进制变量的相关性。所谓二进制变量就是变量的值域只有两个值，例如：性别为男或女；在特定场景下规定变量只有两个可用值，如：规定出行方式为火车或飞机，收入为高或低等。
Fisher精确检验的例子：
1.   两个候选人的得票是否和投票人性别相关。
2.   性别和是否节食是否相关。
3.   收入高低是否和出行方式（火车/飞机）相关。
Fisher精确检验适用于样本量n＜40或者理论频数T＜1的情况。（有的也说理论频数小于5就要用Fisher精确检验？）
其中n为2*2列联表的实际发生的总频数（a+b+c+d），理论频数T是指如果原假设成立则每个格子中理论上应该出现的频数。
对于上述2*2列联表而言：a,b,c,d是实际测试的各个格子实际发生的频数，n为2*2列联表的实际发生的总频数（a+b+c+d）
理论频数是指总体的频数，可以根据检验假设的样本数据推断出近似值。 具体方法是，假设原假设成立，两组样本数据差别仅是由抽样误差所致，则两组样本数据的并集的男性所占比率可以作为总体数据中男性所占比率，即理论频率，如下例：
                                男        女
   节食&不节食          a+c     b+d       ----- 男性所占比率：P=(a+c)/n
    则 总体理论上男的所占频率（比率）可以用 P 来近似表示。因为原假设成立节食与否与男女性别无关，因此在节食的人中男性比率也应该是P。以此为依据便可推算出四格表中相应的四格的理论数。对于a格的理论频数 (a+b)*P = (a+b)*(a+c)/n，即所在行的频数之和*所在列的频数之和/总频数。
