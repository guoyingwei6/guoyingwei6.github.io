---
layout: post
title: "【GWAS】利用PLINK软件进行数据清洗和关联分析"
author: "Yingwei Guo"

---



 ## assoc 基本的case/control关联
 
 质量性状数量性状均可，不能加协变量

 数据过滤：

`plink --tfile /2020060179/Sheep/GWAS/all_sample339.snp.filtered2.final.rename.modified --chr-set 26 --recode transpose --out all_sample339.snp.filtered2.final.rename.modified323.filter --maf 0.05 --geno 0.1 --mind 0.1 --hwe 0.001 --autosome-xy --allow-extra-chr`

 整理性状：

```
cut -d " " -f 1 all_sample339.snp.filtered2.final.rename.modified323.filter.tfam > samples
for i in `cat samples`; do grep $i /2020060179/Sheep/GWAS/trait_tail_type2 >> tail_wool;done
sed -i 's/1$/2/g' tail_wool
sed -i 's/0$/1/g' tail_wool
```

 关联
 质量性状，默认基于卡方检验，

`plink --tfile ../all_sample339.snp.filtered2.final.rename.modified323.filter --pheno tail_wool  --assoc --out tail_wool.assoc --chr-set 26 --allow-no-sex`

 也可以加--fisher进行Fisher精确检验计算精确P值，否则--assoc默认根据chi square分布计算近似P值。
 在大样本的情况下（总样本数＞40），可以用chi square检验，若总样本数＜40，单个最小频数＜5，则用fisher检验较为合适。
 结果文件格式

![image.png](https://s2.loli.net/2022/01/21/xZVmKEtcHMJhlwT.png)
![image.png](https://s2.loli.net/2022/01/21/tZOzpkSeIXjbsNM.png)

 or 对于数量性状，基于t检验，对于数量性状来说--assoc结果和--linear以及--logistic中的ADD效应的P值一样。

`plink --tfile ../all_sample339.snp.filtered2.final.rename.modified323.filter --pheno tail_length --assoc --out tail_length.assoc --chr-set 26 --allow-no-sex`
 结果文件格式

![image.png](https://s2.loli.net/2022/01/21/sZhyFwLbnOSH96R.png)

 协变量为分类变量时，需要转换为虚拟变量/哑变量


![image.png](https://s2.loli.net/2022/01/21/lm8VPeEAnMXsOKj.png)


`plink --tfile all_sample339.snp.filtered2.final.rename.modified323.filter --covar ../covariate_for_plink --write-covar --dummy-coding --out ../dummy_covariate_for_plink --chr-set 26`


 ## logistic 逻辑回归
 
 用于分类变量，可以添加协变量，基于t检验

 PCA结果作为协变量

`plink --tfile all_sample339.snp.filtered2.final.rename.modified323.filter  --pca --chr-set 26 --maf 0.05 --out all_sample339.snp.filtered2.final.rename.modified323.filter.pca`

 关联

`plink --tfile ../all_sample339.snp.filtered2.final.rename.modified323.filter --pheno tail_wool  --logistic --covar ../covariate_for_plink --out tail_wool.logistic --chr-set 26 --allow-no-sex`


 ## linear 线性回归
 
 用于连续性变量，可以添加协变量，基于t检验
 不加协变量

`plink --tfile ../all_sample339.snp.filtered2.final.rename.modified323.filter --pheno tail_length  --linear  --out tail_length.linear.nocov --chr-set 26 --allow-no-sex`
 加上协变量校正
 协变量格式

![image.png](https://s2.loli.net/2022/01/21/67BP2ZFnLoEGW9T.png)

 关联

`plink --tfile ../all_sample339.snp.filtered2.final.rename.modified323.filter --pheno tail_length  --linear --covar ../covariate_for_plink --out tail_length.linear --chr-set 26 --allow-no-sex`
 
 可以加上--hide-covar参数，不显示协变量，只显示ADD加性效应。

`plink --tfile ../all_sample339.snp.filtered2.final.rename.modified323.filter --chr-set 26 --pheno ../all_phenotypes --pheno-name Birth_weight --linear --allow-no-sex --out birth_weight.linear.cov1 --covar ../covariate_for_plink --hide-covar`


 ### 所有表型一起做 --all-pheno
 表型文件格式

![image.png](https://s2.loli.net/2022/01/21/y1ESskrJLehld4Y.png)

 要把里面的尾型记录01替换成12，0会识别成缺失

 关联分析

`plink --tfile all_sample339.snp.filtered2.final.rename.modified323.filter --chr-set 26 --assoc --pheno all_phenotypes --all-pheno --allow-no-sex --out allpheno`


 所有表型一起做一般线性模型

`plink --bfile /2015010726/Sheep/GWAS_for_HuSheep/02.GWAS/by_GEMMA/all_samples317.filter.sort --chr-set 26 --linear hide-covar --pheno /2015010726/Sheep/GWAS_for_HuSheep/02.GWAS/all_phenotypes.txt --all-pheno --allow-no-sex --out allpheno --covar covariate_for_plink_pca3_age_sib`



 pval equal zero 当有P值为0时，设定最小P值

`--output-min-p 1e-99`     any p-value below 10^{-99} will be reported as 10^{-99}

`plink --file /2015010726/Sheep/GWAS_for_Black_Suffolk/01.data/plink/Black_Suffolk.snp.filtered --pheno /2015010726/Sheep/GWAS_for_Black_Suffolk/02.GWAS/all_pheno_mod.grep --pheno-name Chest_width --linear hide-covar --covar ../../covariates_pca3 --chr-set 26 --allow-no-sex --out Chest_width --output-min-p 1e-99`




 ### 加上多重检验的关联分析
 Bonferroni校正

`plink --tfile all_sample339.snp.filtered2.final.rename.modified323.filter --chr-set 26 --assoc --pheno all_phenotypes  --pheno-name tail_type --allow-no-sex --out type --adjust`

 结果文件格式：

![image.png](https://s2.loli.net/2022/01/21/LfsRi36DN4jQcaC.png)

 permutation校正

`plink --tfile all_sample339.snp.filtered2.final.rename.modified323.filter --chr-set 26 --assoc --pheno all_phenotypes --pheno-name tail_type --allow-no-sex --out type --mperm 10000`
 
 or

`plink --tfile all_sample339.snp.filtered2.final.rename.modified323.filter --chr-set 26 --assoc --pheno all_phenotypes --pheno-name Tail_length --allow-no-sex --out Tail_length_msperm --mperm 10000`

 
 结果文件

`sort -k4,4 -g Tail_length_msperm.qassoc.mperm | head`

![image.png](https://s2.loli.net/2022/01/21/J9enaBCoVDMEvzl.png)

 提取P值
`awk '{OFS="\t"}{print $1,$3,$9}' tail_length.linear.nocov.assoc.linear | grep -v 'NA' > tail_length.linear.nocov.assoc.linear.pvalue.txt`


 ## 可视化

```
library(qqman)
data <- read.table("C:/Users/Administrator/Desktop/gwas.assoc.txt",header = T) #读取数去存到data变量里面
colorset<-c("blue4", "orange3")  #创建一个颜色集合
manhattan(data, CHR = "CHR", BP = "bp", SNP = "SNP", p = "P-VALUE", col = colorset)   #画曼哈顿图
```

 或者服务器上一键式
```
source /2015010726/.bashrc
export R_LIBS_USER="/2015010726/R/x86_64-conda_cos6-linux-gnu-library/3.5/"
```

 /2015010726/scripts/Manhattan_QQ_plot.R脚本内容：
```
Object: Manhattan & QQ Plot for genome-wide association study
Output: Single figure with PDF format
Authors: Yingwei Guo
Date: 8th, Jan, 2021
Usage: Rscript commandArgs()[4] pvalue.txt sites_number traits_name

 如果报没有qqman这个包的错误，在shell环境运行下面一行命令：
export R_LIBS_USER="/2015010726/R/x86_64-conda_cos6-linux-gnu-library/3.5/"

library(qqman)
args <- commandArgs(trailingOnly = TRUE)
data <- read.table(args[1],header = T) 读取数去存到data变量里面
colorset <- c("4C72B0", "DD8452")  创建一个颜色集合
pdf(paste0(args[3], ".pdf"), width = 18,height=4.5)
layout(matrix(c(1,2), 1, 2, byrow = TRUE),widths=c(3,1), heights=c(1,1))
par(mar = (c(3,4,2,2)+ 0.5), mgp=c(1.6,1,0))
par(bty="l", lwd=1.5)   bty=l  the plot is coordinate instead of box
manhattan(data, CHR = "CHR", BP = "BP", SNP="SNP", p = "P", suggestiveline = F, genomewideline = F, cex = 0.8)   画曼哈顿图，默认是黑色和灰色，加color=colorset可自定义
sites_number <- as.numeric(args[2])
abline(h=-log10(0.05/sites_number), lty=5, col="grey40")  自定义阈值线，h=-log10(0.05/sites_number)
qq(data$P, cex = 0.8)
dev.off()
```

`Rscript /2015010726/scripts/Manhattan_QQ_plot.R`

 P值列不包含NA的GWAS结果文件 位点数 性状名字
例如：
`Rscript /2015010726/scripts/Manhattan_QQ_plot.R Birth_weight.pvalue.txt 281613 Birth_weight.mht`


 注释

```
for i in Birth_weight Ear_length Ear_width Nose_width tail_circumference Tail_length teat_number ; do sed -i 's/^27/X/' $i.top;done

for i in Birth_weight Ear_length Ear_width Nose_width tail_circumference Tail_length teat_number ; do cut -f 1-2 $i.top |bcftools view -R - /2020055372/sheep_data/call_VCF/all_sample339.snp.filtered2.final.rename.vcf.gz -Oz -o $i.top.vcf.gz ;done

for i in Birth_weight Ear_length Ear_width Nose_width tail_circumference Tail_length teat_number ; do perl /2015010726/software/annovar/table_annovar.pl -buildver OAR4.0 -protocol refGene -operation g -vcfinput $i.top.vcf.gz  /2015010726/Sheep/reference/Oar4.0/annovar_db/ -outfile $i.top; done

for i in Birth_weight Ear_length Ear_width Nose_width tail_circumference Tail_length teat_number ; do sed '1d' $i.top.OAR4.0_multianno.txt | cut -f 1-2,4-10 |csvtk join -t -f "1,2;1,2" -k $i.top - -T > $i.p_anno.txt;done
```

